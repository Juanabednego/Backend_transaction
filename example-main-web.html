<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contoh Web Utama - Integrasi Sistem Pembayaran</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-shop me-2"></i>
                            Integrasi Sistem Pembayaran
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Login Section -->
                        <div id="loginSection" class="mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Login Required</h5>
                                    <p class="text-muted">Silakan login terlebih dahulu untuk melakukan transaksi</p>

                                    <div class="mb-3">
                                        <label class="form-label">Username/Email</label>
                                        <input type="text" class="form-control" id="loginUsername"
                                            placeholder="Masukkan username atau email">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Password</label>
                                        <input type="password" class="form-control" id="loginPassword"
                                            placeholder="Masukkan password">
                                    </div>
                                    <div class="d-grid gap-2 mb-3">
                                        <button onclick="login()" class="btn btn-primary">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>
                                            Login
                                        </button>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted">
                                            Belum punya akun?
                                            <a href="#" onclick="showRegister()">Daftar di sini</a>
                                        </small>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Register Section -->
                        <div id="registerSection" class="mb-4">
                            <h5>Daftar Akun Baru</h5>
                            <p class="text-muted">Buat akun baru untuk mulai bertransaksi</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="regUsername" placeholder="Username">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="regEmail" placeholder="Email">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="regPassword"
                                        placeholder="Password (min 6 karakter)">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Nama Lengkap</label>
                                    <input type="text" class="form-control" id="regFullName" placeholder="Nama Lengkap">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">No. Telepon</label>
                                    <input type="tel" class="form-control" id="regPhone" placeholder="081234567890">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Alamat</label>
                                    <input type="text" class="form-control" id="regAddress"
                                        placeholder="Alamat lengkap">
                                </div>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <button onclick="register()" class="btn btn-success">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Daftar
                                </button>
                                <button onclick="showLogin()" class="btn btn-outline-secondary">
                                    Sudah punya akun? Login
                                </button>
                            </div>
                        </div>

                        <!-- User Info Section -->
                        <div id="userSection" class="mb-4" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h5 class="mb-1">Selamat datang, <span id="userName"></span>!</h5>
                                    <small class="text-muted">Logged in as: <span id="userEmail"></span></small>
                                </div>
                                <button onclick="logout()" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-box-arrow-right me-1"></i>
                                    Logout
                                </button>
                            </div>
                        </div>

                        <!-- Shopping Cart Section -->
                        <div id="cartSection" style="display: none;">
                            <h5>Keranjang Belanja</h5>

                            <!-- Editable Cart Items -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0">Edit Item & Amount untuk Test PGA</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nama Item</label>
                                            <input type="text" class="form-control" id="itemName" value="Produk Test">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="itemQty" value="1" min="1"
                                                onchange="updateTotal()">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Harga Satuan</label>
                                            <input type="number" class="form-control" id="itemPrice" value="100000"
                                                min="1000" onchange="updateTotal()">
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Total Amount (Rp)</strong></label>
                                            <input type="number" class="form-control form-control-lg"
                                                id="totalAmountInput" value="100000" min="1000"
                                                onchange="updateFromTotal()">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Test Scenarios</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                    onclick="setAmount(500000)">500K</button>
                                                <button type="button" class="btn btn-outline-warning btn-sm"
                                                    onclick="setAmount(1200000)">1.2M</button>
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                    onclick="setAmount(5000000)">5M</button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Customer Information -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Informasi Customer</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Nama Lengkap</label>
                                        <input type="text" class="form-control" id="customerName" value="John Doe">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="customerEmail"
                                            value="john.doe@example.com">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Kontak</h6>
                                    <div class="mb-3">
                                        <label class="form-label">No. Telepon</label>
                                        <input type="tel" class="form-control" id="customerPhone" value="081234567890">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Alamat</label>
                                        <textarea class="form-control" id="customerAddress"
                                            rows="2">Jl. Sudirman No. 123, Jakarta</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Button -->
                            <div class="d-grid gap-2">
                                <button onclick="processPayment()" class="btn btn-success btn-lg">
                                    <i class="bi bi-credit-card me-2"></i>
                                    Lanjut ke Pembayaran
                                </button>
                            </div>
                        </div>

                        <!-- Response Display -->
                        <div id="responseArea" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6>Response dari Sistem Pembayaran:</h6>
                                <pre id="responseContent"></pre>
                                <div class="mt-3">
                                    <a id="paymentLink" href="#" class="btn btn-primary" target="_blank">
                                        <i class="bi bi-box-arrow-up-right me-2"></i>
                                        Buka Halaman Pembayaran
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integration Info -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Informasi Integrasi
                        </h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Backend API:</strong> http://localhost:3000</p>
                        <p><strong>Frontend Payment:</strong> http://localhost:5173</p>
                        <p><strong>Endpoint:</strong> POST /api/create-transaction</p>

                        <h6 class="mt-3">Flow Integrasi:</h6>
                        <ol>
                            <li>Web utama mengirim data transaksi ke Backend API</li>
                            <li>Backend API memproses dan mengembalikan URL pembayaran</li>
                            <li>User diarahkan ke halaman pembayaran Frontend</li>
                            <li>User memilih metode pembayaran</li>
                            <li>Sistem memproses pembayaran melalui Midtrans</li>
                            <li>Callback dikirim kembali ke Backend untuk update status</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const BACKEND_URL = 'http://localhost:3000';
        let currentUser = null;

        // Authentication functions
        async function login() {
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    alert('Username dan password harus diisi');
                    return;
                }

                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    // Store token and user data
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user_data', JSON.stringify(result.user));
                    currentUser = result.user;

                    // Update UI
                    showUserSection();

                    alert('Login berhasil!');
                } else {
                    alert('Login gagal: ' + result.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Terjadi kesalahan saat login');
            }
        }

        async function register() {
            try {
                const username = document.getElementById('regUsername').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const full_name = document.getElementById('regFullName').value;
                const phone = document.getElementById('regPhone').value;
                const address = document.getElementById('regAddress').value;

                if (!username || !email || !password || !full_name || !phone || !address) {
                    alert('Semua field harus diisi');
                    return;
                }

                if (password.length < 6) {
                    alert('Password minimal 6 karakter');
                    return;
                }

                const response = await fetch(`${BACKEND_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password, full_name, phone, address })
                });

                const result = await response.json();

                if (result.success) {
                    // Store token and user data
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user_data', JSON.stringify(result.user));
                    currentUser = result.user;

                    console.log('ðŸ” DEBUG - User registered:', result.user);
                    console.log('ðŸ” DEBUG - User ID:', result.user.id);

                    // Update UI
                    showUserSection();

                    alert('Registrasi berhasil!');
                } else {
                    alert('Registrasi gagal: ' + result.message);
                }
            } catch (error) {
                console.error('Register error:', error);
                alert('Terjadi kesalahan saat registrasi');
            }
        }

        async function validateSession() {
            const token = localStorage.getItem('auth_token');

            if (!token) {
                showLoginSection();
                return false;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/validate-session`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success && result.valid) {
                    currentUser = result.user;
                    localStorage.setItem('user_data', JSON.stringify(result.user));
                    showUserSection();
                    return true;
                } else {
                    // Invalid token, clear storage
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    showLoginSection();
                    return false;
                }
            } catch (error) {
                console.error('Session validation error:', error);
                showLoginSection();
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            currentUser = null;
            showLoginSection();
            alert('Logout berhasil');
        }

        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
        }

        function showRegisterSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
        }

        function showUserSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';
            document.getElementById('cartSection').style.display = 'block';

            // Update user info display
            document.getElementById('userName').textContent = currentUser.full_name;
            document.getElementById('userEmail').textContent = currentUser.email;

            // Auto-fill customer details from user profile
            document.getElementById('customerName').value = currentUser.full_name;
            document.getElementById('customerEmail').value = currentUser.email;
            document.getElementById('customerPhone').value = currentUser.phone;
            document.getElementById('customerAddress').value = currentUser.address;
        }

        // Dynamic cart data
        function getCartData() {
            const itemName = document.getElementById('itemName').value || 'Produk Test';
            const itemQty = parseInt(document.getElementById('itemQty').value) || 1;
            const itemPrice = parseInt(document.getElementById('itemPrice').value) || 100000;
            const total = parseInt(document.getElementById('totalAmountInput').value) || 100000;

            return {
                items: [{
                    id: 'PROD001',
                    name: itemName,
                    price: itemPrice,
                    quantity: itemQty
                }],
                total: total
            };
        }

        function updateTotal() {
            const qty = parseInt(document.getElementById('itemQty').value) || 1;
            const price = parseInt(document.getElementById('itemPrice').value) || 100000;
            const total = qty * price;
            document.getElementById('totalAmountInput').value = total;
        }

        function updateFromTotal() {
            const total = parseInt(document.getElementById('totalAmountInput').value) || 100000;
            const qty = parseInt(document.getElementById('itemQty').value) || 1;
            const price = Math.round(total / qty);
            document.getElementById('itemPrice').value = price;
        }

        function setAmount(amount) {
            document.getElementById('totalAmountInput').value = amount;
            updateFromTotal();
        }

        function generateOrderId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            return `ORDER-${timestamp}-${random}`;
        }

        function getCustomerDetails() {
            return {
                first_name: document.getElementById('customerName').value.split(' ')[0] || 'John',
                last_name: document.getElementById('customerName').value.split(' ').slice(1).join(' ') || 'Doe',
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                billing_address: {
                    address: document.getElementById('customerAddress').value,
                    city: 'Jakarta',
                    postal_code: '12345',
                    country_code: 'IDN'
                }
            };
        }

        function getItemDetails(cartData) {
            return cartData.items.map(item => ({
                id: item.id,
                price: item.price,
                quantity: item.quantity,
                name: item.name
            }));
        }

        async function processPayment() {
            try {
                // Show loading
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
                button.disabled = true;

                // Get dynamic cart data
                const cartData = getCartData();

                // Check if user is logged in
                if (!currentUser) {
                    alert('Silakan login terlebih dahulu');
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }

                // Prepare transaction data with user_id
                const transactionData = {
                    order_id: generateOrderId(),
                    amount: cartData.total,
                    user_id: currentUser.id,
                    customer_details: getCustomerDetails(),
                    item_details: getItemDetails(cartData)
                };

                console.log('ðŸ” DEBUG - Current User:', currentUser);
                console.log('ðŸ” DEBUG - Transaction Data:', transactionData);
                console.log('ðŸ” DEBUG - User ID being sent:', transactionData.user_id);
                console.log('ðŸ” DEBUG - User ID type:', typeof transactionData.user_id);

                // Validate user_id before sending
                if (!transactionData.user_id) {
                    console.error('âŒ ERROR - No user_id! Current user:', currentUser);
                    alert('Error: User ID tidak ditemukan. Silakan login ulang.');
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }

                // Send to backend
                const response = await fetch(`${BACKEND_URL}/api/create-transaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });

                const result = await response.json();
                console.log('ðŸ” DEBUG - Backend Response:', result);
                console.log('ðŸ” DEBUG - Payment URL contains user_id:', result.data?.payment_url?.includes('user_id'));
                console.log('ðŸ” DEBUG - Full Payment URL:', result.data?.payment_url);

                // Verify user_id in response
                if (result.success && result.data.user_id) {
                    console.log('âœ… SUCCESS - User ID confirmed in response:', result.data.user_id);
                } else {
                    console.warn('âš ï¸ WARNING - No user_id in backend response');
                }

                // Display response
                document.getElementById('responseContent').textContent = JSON.stringify(result, null, 2);
                document.getElementById('responseArea').style.display = 'block';

                if (result.success && result.data.payment_url) {
                    // Set payment link
                    const paymentLink = document.getElementById('paymentLink');
                    paymentLink.href = result.data.payment_url;

                    // Auto redirect after 3 seconds
                    setTimeout(() => {
                        if (confirm('Redirect ke halaman pembayaran?')) {
                            window.open(result.data.payment_url, '_blank');
                        }
                    }, 3000);
                }

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;

            } catch (error) {
                console.error('Payment processing error:', error);
                alert('Terjadi kesalahan: ' + error.message);

                // Restore button
                const button = event.target;
                button.innerHTML = '<i class="bi bi-credit-card me-2"></i>Lanjut ke Pembayaran';
                button.disabled = false;
            }
        }

        // Format currency for display
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Update display on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateTotal();
            // Check if user is already logged in, otherwise show register
            const token = localStorage.getItem('auth_token');
            if (token) {
                validateSession();
            } else {
                showRegisterSection(); // Show register form by default
            }
        });
    </script>
</body>

</html>